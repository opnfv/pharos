##############################################################################
# Copyright (c) 2018 Mirantis Inc., Enea AB and others.
# All rights reserved. This program and the accompanying materials
# are made available under the terms of the Apache License, Version 2.0
# which accompanies this distribution, and is available at
# http://www.apache.org/licenses/LICENSE-2.0
##############################################################################
{%- import 'net_map.j2' as nm with context %}
---
parameters:
  _param:
    opnfv_maas_timeout_comissioning: {{ nm.maas_timeout_comissioning }}
    opnfv_maas_timeout_deploying: {{ nm.maas_timeout_deploying }}

    opnfv_net_admin_mask: {{ nm.net_admin | ipnet_netmask }}
    opnfv_net_mgmt_mask: {{ nm.net_admin | ipnet_netmask }}
    opnfv_net_private_mask: {{ nm.net_admin | ipnet_netmask }}
    opnfv_net_public_mask: {{ nm.net_public | ipnet_netmask }}

    opnfv_net_public: {{ nm.net_public }}
    opnfv_net_public_gw: {{ nm.net_public_gw }}
    opnfv_net_public_pool_start: {{ nm.net_public_pool_start }}
    opnfv_net_public_pool_end: {{ nm.net_public_pool_end }}

    opnfv_net_tenant_vlan: "{{ nm.vlan_private | string | replace('-', ':') }}"

{%- for network in nm.networks %}
{%- for key in nm.hosts[network] %}
{%- set i = loop.index  + nm.start_ip[network] %}
    {{key}}: {{ network | ipnet_hostaddr(i) }}
{%- endfor %}
{%- endfor %}

    openstack_compute_node_count: {{ nm.cmp_nodes }}

{%- for cmp in range(1, nm.cmp_nodes +1) %}
  {%- set n = '%02d' | format(cmp) %}
    {%- set admin = nm.net_admin_hosts | length + nm.start_ip[nm.net_admin] + loop.index %}
    {%- set mgmt = nm.net_mgmt_hosts | length + nm.start_ip[nm.net_mgmt] + loop.index %}
    {%- set pub = nm.net_public_hosts | length + nm.start_ip[nm.net_public] + loop.index %}
    {%- set pri = nm.net_private_hosts | length + nm.start_ip[nm.net_private] + loop.index %}
    openstack_compute_node{{n}}_pxe_admin_address: {{ nm.net_admin | ipnet_hostaddr(admin) }}
    openstack_compute_node{{n}}_control_address: {{ nm.net_mgmt | ipnet_hostaddr(mgmt) }}
    openstack_compute_node{{n}}_tenant_address: {{ nm.net_private | ipnet_hostaddr(pri) }}
    openstack_compute_node{{n}}_external_address: {{ nm.net_public | ipnet_hostaddr(pub) }}
{%- endfor %}

{%- if nm.cluster.has_baremetal_nodes %}
  maas:
    region:
      machines:
{%- for node in conf.nodes %}
{%- if node.node.type == 'baremetal' %}

{%- if loop.index > nm.cmp001.idx %}
        {{ 'cmp%03d' | format(loop.index - nm.cmp001.idx) }}:
{%- else %}
        {{ 'kvm%02d' | format(loop.index) }}:
{%- endif %}
          interface:
            mac: {{ node.interfaces[nm.idx_admin].mac_address }}
          power_parameters:
            power_address: {{ node.remote_management.address.rsplit('/')[0] }}
            power_password: {{ node.remote_management.pass }}
            power_type: {{ node.remote_management.type }}
            power_user: {{ node.remote_management.user }}
          architecture: {{ node.node.arch | dpkg_arch }}/generic
          distro_series: xenial
          hwe_kernel: ${_param:hwe_kernel}

{%- endif %}
{%- endfor %}
{%- endif %}
