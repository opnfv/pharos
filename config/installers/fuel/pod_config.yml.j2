##############################################################################
# Copyright (c) 2018 Mirantis Inc., Enea AB and others.
# All rights reserved. This program and the accompanying materials
# are made available under the terms of the Apache License, Version 2.0
# which accompanies this distribution, and is available at
# http://www.apache.org/licenses/LICENSE-2.0
##############################################################################
{%- set net = conf.idf.net_config %}
{%- set net_admin = [net.admin.network, net.admin.mask] | join("/")  %}
{%- set net_mgmt = [net.mgmt.network, net.mgmt.mask] | join("/")  %}
{%- set net_private = [net.private.network, net.private.mask] | join("/")  %}
{%- set net_public =  [net.public.network, net.public.mask] | join("/")  %}
{%- set vlan_mgmt = net.mgmt.vlan %}
{%- set vlan_private = net.private.vlan %}
{%- if net.public.dns is defined %}
    {%- set dns_public = net.public.dns %}
{%- endif %}
{%- set pxe_interface = net.admin.interface %}
{%- if net.public.gateway is defined %}
    {%- set net_public_gw = net.public.gateway %}
{%- endif %}
{%- if conf.idf.fuel.network.public_pool is defined %}
    {%- set net_public_pool_start = conf.idf.fuel.network.public_pool.start_ip %}
    {%- set net_public_pool_end = conf.idf.fuel.network.public_pool.end_ip %}
{%- endif %}

{%- if dns_public is not defined %}
    {%- set dns_public = [ '8.8.8.8', '8.8.4.4' ] %}
{%- endif %}
{%- if net_public_gw is not defined %}
    {%- set net_public_gw =  net_public | ipnet_hostmin %}
{%- endif %}
{%- if net_public_pool_start is not defined or net_public_pool_end is not defined %}
    {%- set net_public_pool_start = net_public | ipnet_hostaddr(15) %}
    {%- set net_public_pool_end = net_public | ipnet_hostaddr(25) %}
{%- endif %}
---
parameters:
  _param:

    opnfv_jump_bridge_admin: {{ conf.idf.fuel.jumphost.bridges.admin }}
    opnfv_jump_bridge_mgmt: {{ conf.idf.fuel.jumphost.bridges.mgmt }}
    opnfv_jump_bridge_private: {{ conf.idf.fuel.jumphost.bridges.private }}
    opnfv_jump_bridge_public: {{ conf.idf.fuel.jumphost.bridges.public }}

    opnfv_infra_config_address: {{ net_mgmt | ipnet_hostaddr(100) }}
    opnfv_infra_config_pxe_address: {{ net_admin | ipnet_hostaddr(2) }}
    opnfv_infra_maas_node01_address: {{ net_mgmt | ipnet_hostaddr(3) }}
    opnfv_infra_maas_node01_deploy_address: {{ net_admin | ipnet_hostaddr(3) }}
    opnfv_infra_kvm_address: {{ net_mgmt | ipnet_hostaddr(140) }}
    opnfv_infra_kvm_node01_address: {{ net_mgmt | ipnet_hostaddr(141) }}
    opnfv_infra_kvm_node02_address: {{ net_mgmt | ipnet_hostaddr(142) }}
    opnfv_infra_kvm_node03_address: {{ net_mgmt | ipnet_hostaddr(143) }}

    opnfv_infra_maas_pxe_network_address: {{ net.admin.network }}
    opnfv_infra_maas_pxe_start_address: {{ net_admin | ipnet_hostaddr(4) }}
    opnfv_infra_maas_pxe_end_address: {{ net_admin | ipnet_hostmax }}

    opnfv_openstack_gateway_node01_address: {{ net_mgmt | ipnet_hostaddr(124) }}
    opnfv_openstack_gateway_node02_address: {{ net_mgmt | ipnet_hostaddr(125) }}
    opnfv_openstack_gateway_node03_address: {{ net_mgmt | ipnet_hostaddr(126) }}
    opnfv_openstack_gateway_node01_tenant_address: {{ net_private | ipnet_hostaddr(124) }}
    opnfv_openstack_gateway_node02_tenant_address: {{ net_private | ipnet_hostaddr(125) }}
    opnfv_openstack_gateway_node03_tenant_address: {{ net_private | ipnet_hostaddr(126) }}
    opnfv_openstack_gateway_node01_external_address: {{ net_public | ipnet_hostaddr(8) }}
    opnfv_openstack_gateway_node02_external_address: {{ net_public | ipnet_hostaddr(9) }}
    opnfv_openstack_gateway_node03_external_address: {{ net_public | ipnet_hostaddr(10) }}
    opnfv_openstack_proxy_address: {{ net_public | ipnet_hostaddr(2) }}
    opnfv_openstack_proxy_node01_address: {{ net_public | ipnet_hostaddr(3) }}
    opnfv_openstack_proxy_node02_address: {{ net_public | ipnet_hostaddr(4) }}
    opnfv_openstack_proxy_control_address: {{ net_mgmt | ipnet_hostaddr(103) }}
    opnfv_openstack_proxy_node01_control_address: {{ net_mgmt | ipnet_hostaddr(104) }}
    opnfv_openstack_proxy_node02_control_address: {{ net_mgmt | ipnet_hostaddr(105) }}
    opnfv_openstack_control_address: {{ net_mgmt | ipnet_hostaddr(10) }}
    opnfv_openstack_control_node01_address: {{ net_mgmt | ipnet_hostaddr(11) }}
    opnfv_openstack_control_node02_address: {{ net_mgmt | ipnet_hostaddr(12) }}
    opnfv_openstack_control_node03_address: {{ net_mgmt | ipnet_hostaddr(13) }}
    opnfv_openstack_control_node01_external_address: {{ net_public | ipnet_hostaddr(11) }}
    opnfv_openstack_control_node02_external_address: {{ net_public | ipnet_hostaddr(12) }}
    opnfv_openstack_control_node03_external_address: {{ net_public | ipnet_hostaddr(13) }}
    opnfv_openstack_database_address: {{ net_mgmt | ipnet_hostaddr(50) }}
    opnfv_openstack_database_node01_address: {{ net_mgmt | ipnet_hostaddr(51) }}
    opnfv_openstack_database_node02_address: {{ net_mgmt | ipnet_hostaddr(52) }}
    opnfv_openstack_database_node03_address: {{ net_mgmt | ipnet_hostaddr(53) }}
    opnfv_openstack_message_queue_address: {{ net_mgmt | ipnet_hostaddr(40) }}
    opnfv_openstack_message_queue_node01_address: {{ net_mgmt | ipnet_hostaddr(41) }}
    opnfv_openstack_message_queue_node02_address: {{ net_mgmt | ipnet_hostaddr(42) }}
    opnfv_openstack_message_queue_node03_address: {{ net_mgmt | ipnet_hostaddr(43) }}
    opnfv_openstack_telemetry_address: {{ net_mgmt | ipnet_hostaddr(75) }}
    opnfv_openstack_telemetry_node01_address: {{ net_mgmt | ipnet_hostaddr(76) }}
    opnfv_openstack_telemetry_node02_address: {{ net_mgmt | ipnet_hostaddr(77) }}
    opnfv_openstack_telemetry_node03_address: {{ net_mgmt | ipnet_hostaddr(78) }}
    opnfv_openstack_compute_node01_single_address: {{ net_mgmt | ipnet_hostaddr(101) }}
    opnfv_openstack_compute_node02_single_address: {{ net_mgmt | ipnet_hostaddr(102) }}
    opnfv_openstack_compute_node03_single_address: {{ net_mgmt | ipnet_hostaddr(103) }}
    opnfv_openstack_compute_node01_control_address: {{ net_mgmt | ipnet_hostaddr(101) }}
    opnfv_openstack_compute_node02_control_address: {{ net_mgmt | ipnet_hostaddr(102) }}
    opnfv_openstack_compute_node03_control_address: {{ net_mgmt | ipnet_hostaddr(103) }}
    opnfv_openstack_compute_node01_tenant_address: {{ net_private | ipnet_hostaddr(101) }}
    opnfv_openstack_compute_node02_tenant_address: {{ net_private | ipnet_hostaddr(102) }}
    opnfv_openstack_compute_node03_tenant_address: {{ net_private | ipnet_hostaddr(103) }}
    opnfv_openstack_compute_node01_external_address: {{ net_public | ipnet_hostaddr(5) }}
    opnfv_openstack_compute_node02_external_address: {{ net_public | ipnet_hostaddr(6) }}
    opnfv_openstack_compute_node03_external_address: {{ net_public | ipnet_hostaddr(7) }}
    opnfv_opendaylight_server_node01_single_address: {{ net_mgmt | ipnet_hostaddr(111) }}

    opnfv_net_public: {{ net_public }}
    opnfv_net_public_mask: {{ net_public | ipnet_netmask }}
    opnfv_net_public_gw: {{ net_public_gw }}
    opnfv_net_public_pool_start: {{ net_public_pool_start }}
    opnfv_net_public_pool_end: {{ net_public_pool_end }}
    opnfv_name_servers: {{ dns_public }}
    opnfv_dns_server01: '{{ dns_public[0] }}'

    opnfv_net_mgmt_vlan: {{ vlan_mgmt }}
    opnfv_net_tenant_vlan: {{ vlan_private }}

    opnfv_maas_node01_architecture: '{{ conf.nodes.0.node.arch | dpkg_arch }}/generic'
    opnfv_maas_node01_power_address: {{ conf.nodes.0.remote_management.address.rsplit('/')[0] }}
    opnfv_maas_node01_power_type: {{ conf.nodes.0.remote_management.type }}
    opnfv_maas_node01_power_user: {{ conf.nodes.0.remote_management.user }}
    opnfv_maas_node01_power_password: {{ conf.nodes.0.remote_management.pass }}
    opnfv_maas_node01_interface_mac: '{{ conf.nodes.0.interfaces[pxe_interface].mac_address }}'

    opnfv_maas_node02_architecture: '{{ conf.nodes.1.node.arch | dpkg_arch }}/generic'
    opnfv_maas_node02_power_address: {{ conf.nodes.1.remote_management.address.rsplit('/')[0] }}
    opnfv_maas_node02_power_type: {{ conf.nodes.1.remote_management.type }}
    opnfv_maas_node02_power_user: {{ conf.nodes.1.remote_management.user }}
    opnfv_maas_node02_power_password: {{ conf.nodes.1.remote_management.pass }}
    opnfv_maas_node02_interface_mac: '{{ conf.nodes.1.interfaces[pxe_interface].mac_address }}'

    opnfv_maas_node03_architecture: '{{ conf.nodes.2.node.arch | dpkg_arch }}/generic'
    opnfv_maas_node03_power_address: {{ conf.nodes.2.remote_management.address.rsplit('/')[0] }}
    opnfv_maas_node03_power_type: {{ conf.nodes.2.remote_management.type }}
    opnfv_maas_node03_power_user: {{ conf.nodes.2.remote_management.user }}
    opnfv_maas_node03_power_password: {{ conf.nodes.2.remote_management.pass }}
    opnfv_maas_node03_interface_mac: '{{ conf.nodes.2.interfaces[pxe_interface].mac_address }}'

    opnfv_maas_node04_architecture: '{{ conf.nodes.3.node.arch | dpkg_arch }}/generic'
    opnfv_maas_node04_power_address: {{ conf.nodes.3.remote_management.address.rsplit('/')[0] }}
    opnfv_maas_node04_power_type: {{ conf.nodes.3.remote_management.type }}
    opnfv_maas_node04_power_user: {{ conf.nodes.3.remote_management.user }}
    opnfv_maas_node04_power_password: {{ conf.nodes.3.remote_management.pass }}
    opnfv_maas_node04_interface_mac: '{{ conf.nodes.3.interfaces[pxe_interface].mac_address }}'

    opnfv_maas_node05_architecture: '{{ conf.nodes.4.node.arch | dpkg_arch }}/generic'
    opnfv_maas_node05_power_address: {{ conf.nodes.4.remote_management.address.rsplit('/')[0] }}
    opnfv_maas_node05_power_type: {{ conf.nodes.4.remote_management.type }}
    opnfv_maas_node05_power_user: {{ conf.nodes.4.remote_management.user }}
    opnfv_maas_node05_power_password: {{ conf.nodes.4.remote_management.pass }}
    opnfv_maas_node05_interface_mac: '{{ conf.nodes.4.interfaces[pxe_interface].mac_address }}'
